<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <title>Elevators Exercise</title>
    <link rel="stylesheet" href="ElevatorsStyles.css" />
  </head>

  <body>
	<div class="timeDisplay" id="1"></div>
	<div class="timeDisplay" id="2"></div>
	<div class="timeDisplay" id="3"></div>
	<div class="timeDisplay" id="4"></div>
	<div class="timeDisplay" id="5"></div>
    <table>
      <caption>
        <strong>Elevator Exercise</strong>
      </caption>
      <tbody>
		<tr>
          <th class="left">9th</th>
		  <td></td>
		  <td></td>
		  <td></td>
          <td></td>
		  <td></td>
          <th class="right">
            <button id="9" class="myButtons">Call</button>
          </th>
        </tr>
		<tr>
          <th class="left">8th</th>
		  <td></td>
		  <td></td>
		  <td></td>
          <td></td>
		  <td></td>
          <th class="right">
            <button id="8" class="myButtons">Call</button>
          </th>
        </tr>
		<tr>
          <th class="left">7th</th>
		  <td></td>
		  <td></td>
		  <td></td>
          <td></td>
		  <td></td>
          <th class="right">
            <button id="7" class="myButtons">Call</button>
          </th>
        </tr>
		<tr>
          <th class="left">6th</th>
		  <td></td>
		  <td></td>
		  <td></td>
          <td></td>
		  <td></td>
          <th class="right">
            <button id="6" class="myButtons">Call</button>
          </th>
        </tr>
		<tr>
          <th class="left">5th</th>
		  <td></td>
		  <td></td>
		  <td></td>
          <td></td>
		  <td></td>
          <th class="right">
            <button id="5" class="myButtons">Call</button>
          </th>
        </tr>
		<tr>
          <th class="left">4th</th>
		  <td></td>
		  <td></td>
		  <td></td>
          <td></td>
		  <td></td>
          <th class="right">
            <button id="4" class="myButtons">Call</button>
          </th>
        </tr>
        <tr>
          <th class="left">3rd</th>
		  <td></td>
		  <td></td>
		  <td></td>
          <td></td>
		  <td></td>
          <th class="right">
            <button id="3" class="myButtons">Call</button>
          </th>
        </tr>
        <tr>
          <th class="left">2nd</th>
		  <td></td>
		  <td></td>
		  <td></td>
		  <td></td>
          <td></td>
          <th class="right">
            <button id="2" class="myButtons">Call</button>
          </th>
        </tr>
        <tr>
          <th class="left">1st</th>
		  <td></td>
		  <td></td>
		  <td></td>
		  <td></td>
          <td></td>
          <th class="right">
            <button id="1" class="myButtons">Call</button>
          </th>
        </tr>
        <tr>
          <th class="left">Ground Floor</th>
		  <td>
		    <svg id="0" viewBox="0 0 170 170" xmlns="http://www.w3.org/2000/svg">
			  <image href="iconElevator.svg" alt="an elevator">
			</svg>
		  </td>
		  <td>
		    <svg id="1" viewBox="0 0 170 170" xmlns="http://www.w3.org/2000/svg">
			  <image href="iconElevator.svg" alt="an elevator">
			</svg>
		  </td>
		  <td>
		    <svg id="2" viewBox="0 0 170 170" xmlns="http://www.w3.org/2000/svg">
			  <image href="iconElevator.svg" alt="an elevator">
			</svg>
		  </td>
		  <td>
		    <svg id="3" viewBox="0 0 170 170" xmlns="http://www.w3.org/2000/svg">
			  <image href="iconElevator.svg" alt="an elevator">
			</svg>
		  </td>
          <td>
		    <svg id="4" viewBox="0 0 170 170" xmlns="http://www.w3.org/2000/svg">
			  <image href="iconElevator.svg" alt="an elevator">
			</svg>
		  </td>
          <th class="right">
            <button id="0" class="myButtons">Call</button>
          </th>
        </tr>
      </tbody>
    </table>
	<script>
		// Get the computed value of --cell-height from the :root pseudo-element
		const rootStyles = getComputedStyle(document.documentElement);
		const cellHeight = parseInt(rootStyles.getPropertyValue('--cell-height'));
		
		
		const buttons = document.querySelectorAll("button");
		const elevators = document.querySelectorAll("svg");
		
		/*
		let freeElevatorsPos = {0: [0,1,2,3,4]};
		for(let i = 1; i<10; i++){
			freeElevatorsPos[i] = [];
		}*/
		let freeElevatorsPos = {};
		for(let i = 0; i<5; i++){
			freeElevatorsPos[i] = 0;
		}
		
		let busyElevators = [];
		
		let buttonQueue = new Set();
		
		let elevatorsVelocity = [3,3,3,3,3]; // base stats: it takes 3 second to reach 1 floor
		const timeOfElev = 3000; // MIGHT NEED TO CHANGE LATER
		const greenDelay = 2000;
		const waitDelay = 500;
		
		const timerElement = document.querySelectorAll('timeDisplay');
		let startTime = 0;
		let intervalId = 0;
		let elevatorStartTime = [0,0,0,0,0];
		let elevatorTimers = [0,0,0,0,0];
		
		function busyButton(button){
			button.style.backgroundColor = "red";
			button.style.borderColor = "red";
			button.textContent = "Waiting";
		}
		
		function closestElevator(lvl){
			if(busyElevators.length === 5){
				return -1;
			}
			
			let elev = 0;
			
			while(elev < 5 && freeElevatorsPos[elev] === -1){ //find the first free elevator
				elev++;
			}
			if(elev === 5){
				return -1;
			}
			
			for(let i = elev + 1; i<5; i++){
				if(freeElevatorsPos[i] != -1 && Math.abs(lvl-freeElevatorsPos[elev]) > Math.abs(lvl-freeElevatorsPos[i])){
					elev = i;
				}
			}
			if(freeElevatorsPos[elev] === -1){
				return -1;
			}
			else{
				busyElevators.push(elev);
				return elev;
			}
		/*
			let closest = 0;
			while(closest < 10 && freeElevatorsPos[closest].length === 0){
					closest++;
				}
			if(closest === 10){
				return -1;
			}
			for(let i = 1; i<10; i++){
				if(freeElevatorsPos[i].length != 0 && Math.abs(lvl-i) < Math.abs(lvl-closest)){
					closest = i;
				}
			}
			let elevId = Number(freeElevatorsPos[closest].shift());
			if(elevId != 0 && !elevId)
				return -1;
			busyElevators.push(elevId);
			return elevId;*/
		}
		
		function elevatorAnimation(elevatorId, lvl){
			const numOfLvls = Math.abs(Number(lvl)-freeElevatorsPos[elevatorId]);
			freeElevatorsPos[elevatorId] = -1;
			const velocity = numOfLvls * 3; //3 is the time between 2 adjacent levels(lvls)
			elevators[elevatorId].style.transition = `transform ${velocity}s ease-out`;
			const level = -1.42 * Number(lvl) * cellHeight;
			
			
			elevatorsVelocity[elevatorId] = velocity;
			elevators[elevatorId].style.transform = `translate(${0}px, ${level}px)`;
			elevators[elevatorId].style.backgroundColor = "red";
		}
		
		function startTimer(wantedElevId) {
			startTime = Math.floor(Date.now()/1000); // set the start time to the current time
			elevatorStartTime[wantedElevId] = startTime;// update the timer every second
		}
		
		function updateTimer() {
			/*let elapsed = Date.now() - startTime; // calculate the elapsed time in milliseconds
			timerElement.style.transform = "translate(233px,110px)";
			timerElement.textContent = (elapsed / 1000).toFixed(1) + "s";*/ // display the elapsed time in seconds with one decimal point
			
			let currentTime = performance.now();
			for (let i = 0; i < elevatorTimers.length; i++) {
				let timer = elevatorTimers[i];
				let timeDiff = Math.floor((currentTime - timer.start) / 1000); // convert to seconds
				let timerEl = document.getElementById(`timer-${timer.elevator}-${timer.floor}`);
				timerEl.textContent = timeDiff + 's';
			}
			setTimeout(updateTimers, 1000); // update timers every second
		}
		
		function elevatorArrived(wantedElevId, curr_button){
			let currTime = Math.floor(Date.now()/1000);
			elevatorTimers[wantedElevId] = currTime - elevatorStartTime[wantedElevId];
			elevators[wantedElevId].style.backgroundColor = "lightgreen";
			curr_button.style.backgroundColor = "#dedede";
			curr_button.style.borderColor = "";
			curr_button.style.color = "mediumSeaGreen";
			curr_button.style.fontWeight = "bold";
			curr_button.textContent = "Arrived";
		}
		
		function resetElevButton(wantedElevId, curr_button){
			elevators[wantedElevId].style.backgroundColor = "";
			curr_button.textContent = "Call";
			curr_button.style.fontWeight = "";
			curr_button.style.color = "";
			curr_button.style.backgroundColor = "";
			curr_button.disabled = false;
		}
		
		function calledAnElevator(event){
			let curr_button = event.target;
			/* time stuff 
			let timerStart = null;
			timerStart = performance.now();
			let elapsedTime = performance.now() - timerStart;
			document.getElementById('timeDisplay').textContent = `${elapsedTime}ms`;*/
	
			//startTimer();

			busyButton(curr_button);
			
			if(buttonQueue.size != 0) {
				buttonQueue.add(curr_button.id)
				const id = buttonQueue.values().next().value;
				curr_button = buttons[9-id];
			}
			
			/*check if there is a free elevator. if not- add button to queue*/
			if(busyElevators.length === 5){
				buttonQueue.add(curr_button.id);
				return;
			}
			
			const wantedElevId = closestElevator(curr_button.id);
			if(wantedElevId === -1){
				buttonQueue.add(curr_button.id);
				return;
			}
			if(buttonQueue.has(curr_button.id)){ // the button was in queue and we have a free elevator for him, so dequeue him
				buttonQueue.delete(curr_button.id);
			}
			/*~~~~~~~~~~~~~~~~~~~~~~~ timeeee ~~~~~~~~~~~~~~~~~~
			let timer = {
				start: performance.now(), // start time
				elevator: wantedElevId, // elevator number
				floor: curr_button.id // floor number
			};
			elevatorTimers.push(timer);
			intervalId = setInterval(updateTimer, 1000);*/

			curr_button.disabled = true;
			
			elevatorAnimation(wantedElevId, curr_button.id);
			startTimer(wantedElevId);
			
			setTimeout(() => {
				const sound = new Audio('ding.mp3');
				sound.play();
				
				/*time stuff
				elapsedTime = performance.now() - timerStart;
				document.getElementById('timeDisplay').textContent = `${elapsedTime}ms`;
				timerStart = null;
				clearInterval(intervalId);
				startTime = null;*/
				
				elevatorArrived(wantedElevId, curr_button);
				
				/*~~~~~~~~~~~~~~~~~~ time ~~~~~~~~~~~~~~~~~
				for (let i = 0; i < elevatorTimers.length; i++) {
					let timer = elevatorTimers[i];
					if (timer.elevator === elevatorNumber && timer.floor === floorNumber) {
						elevatorTimers.splice(i, 1);
						break;
					}
				}*/
				setTimeout(() => {
					resetElevButton(wantedElevId, curr_button)
					
					const index = busyElevators.indexOf(wantedElevId);
					busyElevators.splice(index, 1);
					freeElevatorsPos[wantedElevId] = curr_button.id;
				}, greenDelay);
			}, elevatorsVelocity[wantedElevId]*1000); // *1000 cause 1 second is 1000
		}
		
		buttons.forEach(button => {
			button.addEventListener('click', calledAnElevator)
		});
		
		function checkButtonQueue(){
			if(buttonQueue.size != 0) {
				const id = buttonQueue.values().next().value;
				buttons[9-id].click();
			}
		}
		
		setInterval(checkButtonQueue, 500);
		
	</script>
	
  </body>
</html>
